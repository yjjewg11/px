/**
 * lrz3
 * https://github.com/think2011/localResizeIMG3
 * @author think2011
 */(function(){function h(a,c){this.file=a;this.defaults={quality:.7,done:null,fail:null,before:null,always:null};for(var b in c)this.defaults[b]=c[b];1<this.defaults.quality&&(this.defaults.quality=1);this.results={origin:null,base64:null,base64Len:null};this.init()}window.URL=window.URL||window.webkitURL;var l=detect.parse(navigator.userAgent);h.prototype={constructor:h,init:function(){if("undefined"===typeof window.URL||"function"!==typeof document.createElement("canvas").getContext){var a=Error("\u4e0d\u652f\u6301\u6b64\u8bbe\u5907");"function"===typeof this.defaults.fail&&this.defaults.fail(a);"function"===typeof this.defaults.always&&this.defaults.always()}else this.create(this.file)},create:function(a){var c=this,b=new Image,g=c.results,h="string"===typeof a?a:URL.createObjectURL(a);b.crossOrigin="*";b.onerror=function(){var a=Error("\u56fe\u7247\u52a0\u8f7d\u5931\u8d25");"function"===typeof c.defaults.fail&&c.defaults.fail(a);"function"===typeof c.defaults.always&&c.defaults.always()};b.onload=function(){var d=c.resize(this);EXIF.getData(b,function(){var k=EXIF.getTag(this,"Orientation"),e=document.createElement("canvas"),f;c.rotateResize(d,k);e.width=d.w;e.height=d.h;f=e.getContext("2d");f.fillStyle="#fff";f.fillRect(0,0,d.w,d.h);g.origin=a;if("iOS"===l.os.family&&8>+l.os.version)(new MegaPixImage(b)).render(e,{width:e.width,height:e.height,orientation:k}),g.base64=e.toDataURL("image/jpeg",c.defaults.quality);else{switch(k){case 3:f.rotate(180*Math.PI/180);f.drawImage(b,-d.w,-d.h,d.w,d.h);break;case 6:e.width=d.h;e.height=d.w;f.rotate(90*Math.PI/180);f.drawImage(b,0,-d.h,d.w,d.h);break;case 8:e.width=d.h;e.height=d.w;f.rotate(270*Math.PI/180);f.drawImage(b,-d.w,0,d.w,d.h);break;default:f.drawImage(b,0,0,d.w,d.h)}"Android"===l.os.family&&4.5>l.os.version.slice(0,3)?(k=new JPEGEncoder,g.base64=k.encode(f.getImageData(0,0,e.width,e.height),100*c.defaults.quality)):g.base64=e.toDataURL("image/jpeg",c.defaults.quality)}b=canvas=null;URL.revokeObjectURL(h);g.base64Len=g.base64.length;"function"===typeof c.defaults.done&&c.defaults.done(g);"function"===typeof c.defaults.always&&c.defaults.always()})};"function"===typeof this.defaults.before&&this.defaults.before();b.src=h},resize:function(a){var c=this.defaults.width,b=this.defaults.height,g=a.width/a.height;a={w:a.width,h:a.height};c&b?(a.w=c,a.h=b):c?(a.w=c,a.h=Math.ceil(c/g)):b&&(a.w=Math.ceil(b*g),a.h=b);if(3264<=a.w||2448<=a.h)a.w*=.8,a.h*=.8;return a},rotateResize:function(a,c){switch(c){case 6:case 8:if(this.defaults.width&&this.defaults.height){var b=a.w;a.w=a.h;a.h=b;return!1}if(this.defaults.width)return a.w>a.h?(b=a.w-a.h,a.w+=b,a.h+=b):a.w<a.h&&(b=a.h-a.w,a.w-=b,a.h-=b),!1;if(this.defaults.height)return a.w>a.h?(b=a.w-a.h,a.w-=b,a.h-=b):a.w<a.h&&(b=a.h-a.w,a.w+=b,a.h+=b),!1}}};window.lrz=function(a,c){return new h(a,c)}})();