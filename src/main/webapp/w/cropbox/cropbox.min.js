(function(e){"function"===typeof define&&define.amd?define(["jquery"],e):e(jQuery)})(function(e){var k=function(c,b){b=b||e(c.imageBox);var a={state:{},ratio:1,options:c,imageBox:b,thumbBox:b.find(c.thumbBox),spinner:b.find(c.spinner),image:new Image,getDataURL:function(){var a=this.thumbBox.width(),m=this.thumbBox.height(),d=document.createElement("canvas"),f=b.css("background-position").split(" "),c=b.css("background-size").split(" "),e=parseInt(f[0])-b.width()/2+a/2,f=parseInt(f[1])-b.height()/2+m/2,g=parseInt(c[0]),c=parseInt(c[1]),h=parseInt(this.image.height),k=parseInt(this.image.width);d.width=a;d.height=m;d.getContext("2d").drawImage(this.image,0,0,k,h,e,f,g,c);return d.toDataURL("image/png")},getBlob:function(){for(var a=this.getDataURL().replace("data:image/png;base64,",""),a=atob(a),b=[],d=0;d<a.length;d++)b.push(a.charCodeAt(d));return new Blob([new Uint8Array(b)],{type:"image/png"})},zoomIn:function(){this.ratio*=1.1;g()},zoomOut:function(){this.ratio*=.9;g()}},g=function(){var l=parseInt(a.image.width)*a.ratio,c=parseInt(a.image.height)*a.ratio,d=(b.width()-l)/2,f=(b.height()-c)/2;b.css({"background-image":"url("+a.image.src+")","background-size":l+"px "+c+"px","background-position":d+"px "+f+"px","background-repeat":"no-repeat"})},k=function(b){b.stopImmediatePropagation();a.state.dragable=!0;a.state.mouseX=b.clientX;a.state.mouseY=b.clientY},n=function(c){c.stopImmediatePropagation();if(a.state.dragable){var e=c.clientX-a.state.mouseX,d=c.clientY-a.state.mouseY,f=b.css("background-position").split(" "),e=e+parseInt(f[0]),d=d+parseInt(f[1]);b.css("background-position",e+"px "+d+"px");a.state.mouseX=c.clientX;a.state.mouseY=c.clientY}},h=function(b){b.stopImmediatePropagation();a.state.dragable=!1},p=function(b){0<b.originalEvent.wheelDelta||0>b.originalEvent.detail?a.ratio*=1.1:a.ratio*=.9;g()};a.spinner.show();a.image.onload=function(){a.spinner.hide();a.ratio=b.width()/parseInt(a.image.width);g();b.bind("mousedown",k);b.bind("mousemove",n);e(window).bind("mouseup",h);b.bind("mouseup",h);b.bind("mousewheel DOMMouseScroll",p)};a.image.src=c.imgSrc;b.on("remove",function(){e(window).unbind("mouseup",h)});return a};jQuery.fn.cropbox=function(c){return new k(c,this)}});